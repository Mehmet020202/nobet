import{b as w,j as e}from"./radix-ui-DGgDhZMf.js";import{c as J,B,U as I,C as O}from"./index-3ZT1LmJ7.js";import{u as G,C as M,a as Q,d as k}from"./useIndexedDB-CLkKVxWR.js";import{B as R}from"./badge-DB7DNGFt.js";import{S as L,a as z,b as F,c as Y,d as V}from"./select-CqJO4d4P.js";import"./pdf-ckwbz45p.js";import"./utils-B6LxV9S2.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],q=J("refresh-cw",X),Z=()=>{const{getRedDays:C,getBlueDays:E,getSpecialAssignments:g}=G(),N=async(u,o,i)=>{if(!u||u.length===0)throw new Error("Doktor listesi boş!");console.log(`Nöbet planlaması: ${u.length} doktor için ${o}-${i} ayı`);const d=new Date(o,i,0).getDate(),h=[],m=await Promise.all(u.map(async s=>{const[l,a,n]=await Promise.all([C(s.id),E(s.id),g(s.id)]);return{...s,redDays:l||[],blueDays:a||[],specialAssignments:n||{},remainingDuties24h:6,remainingDuties16h:2,lastDutyDate:null}})),p={morning:4,evening:4,night:3};for(let s=1;s<=d;s++){const l=`${o}-${String(i).padStart(2,"0")}-${String(s).padStart(2,"0")}`,a=`${o}-${String(i).padStart(2,"0")}`,n=new Date(o,i-1,s);n.getDay()===0||n.getDay();const f=[];m.forEach(r=>{if(r.specialAssignments[l]){const b=r.specialAssignments[l];f.push({doctor_id:r.id,shift_type:b,date:l,year_month:a,is_special:!0}),b==="night"?r.remainingDuties16h=Math.max(0,r.remainingDuties16h-1):r.remainingDuties24h=Math.max(0,r.remainingDuties24h-1),r.lastDutyDate=l}}),h.push(...f);const S={...p};f.forEach(r=>{S[r.shift_type]=Math.max(0,S[r.shift_type]-1)});for(const[r,b]of Object.entries(S)){if(b===0)continue;D(m,r,l,b,f.map(v=>v.doctor_id)).forEach(v=>{h.push({doctor_id:v,shift_type:r,date:l,year_month:a,is_special:!1});const y=m.find(_=>_.id===v);y&&(r==="night"?y.remainingDuties16h=Math.max(0,y.remainingDuties16h-1):y.remainingDuties24h=Math.max(0,y.remainingDuties24h-1),y.lastDutyDate=l)})}}return h},D=(u,o,i,d,h)=>{const m=u.filter(s=>{if(h.includes(s.id)||s.redDays&&s.redDays.includes(i))return!1;if(s.blueDays&&s.blueDays.includes(i))return!0;if(!(o==="night"?s.remainingDuties16h>0:s.remainingDuties24h>0))return!1;if(s.lastDutyDate){const a=new Date(s.lastDutyDate),n=new Date(i);if(Math.abs((n-a)/(1e3*60*60*24))<1)return!1}return!0});m.sort((s,l)=>{const a=o==="night"?s.remainingDuties16h:s.remainingDuties24h;return(o==="night"?l.remainingDuties16h:l.remainingDuties24h)-a});const p=m.slice(0,d);return p.length<d&&console.warn(`Warning: Could not assign enough doctors for ${o} shift on ${i}. Required: ${d}, Assigned: ${p.length}`),p.map(s=>s.id)};return{generateMonthlySchedule:N,validateSchedule:(u,o)=>{const i=[],d={};o.forEach(a=>{d[a.id]={name:a.name,totalDuties:0,morningDuties:0,eveningDuties:0,nightDuties:0,consecutiveDuties:[]}}),u.forEach(a=>{const n=d[a.doctor_id];n&&(n.totalDuties++,n[`${a.shift_type}Duties`]++)});const h=u.sort((a,n)=>new Date(a.date)-new Date(n.date)),m={};h.forEach(a=>{const n=m[a.doctor_id];if(n){const f=new Date(n.date);(new Date(a.date)-f)/(1e3*60*60*24)===1&&i.push({type:"consecutive_duty",doctor_id:a.doctor_id,dates:[n.date,a.date],message:`${d[a.doctor_id].name} has consecutive duties on ${n.date} and ${a.date}`})}m[a.doctor_id]=a});const s=u.length/o.length,l=2;return Object.entries(d).forEach(([a,n])=>{Math.abs(n.totalDuties-s)>l&&i.push({type:"unfair_distribution",doctor_id:a,actual:n.totalDuties,expected:Math.round(s),message:`${n.name} has ${n.totalDuties} duties, expected around ${Math.round(s)}`})}),{isValid:i.length===0,issues:i,statistics:d}}}},le=()=>{const[C,E]=w.useState(new Date),[g,N]=w.useState(new Date().getMonth()),[D,A]=w.useState(new Date().getFullYear()),[u,o]=w.useState([]),[i,d]=w.useState([]),[h,m]=w.useState(!1),{getDoctors:p,getDuties:s,saveDuties:l}=G(),{generateMonthlySchedule:a}=Z();w.useEffect(()=>{n()},[g,D]);const n=async()=>{try{const[t,c]=await Promise.all([p(),s(D,g+1)]);d(t),o(c)}catch(t){console.error("Error loading data:",t)}},f=async()=>{if(i.length===0){alert("Önce doktor ekleyiniz!");return}m(!0);try{const t=await a(i,D,g+1);await l(t),await n()}catch(t){console.error("Error generating schedule:",t),alert("Nöbet programı oluşturulurken hata oluştu!")}finally{m(!1)}},S=(t,c)=>new Date(t,c+1,0).getDate(),r=(t,c)=>new Date(t,c,1).getDay(),b=t=>{const c=`${D}-${String(g+1).padStart(2,"0")}-${String(t).padStart(2,"0")}`;return u.filter(j=>j.date===c)},P=t=>{const c=i.find(j=>j.id===t);return c?c.name:"Bilinmeyen"},v=t=>{switch(t){case"morning":return"Sabah";case"evening":return"Akşam";case"night":return"Gece";default:return t}},y=t=>{switch(t){case"morning":return"bg-yellow-100 text-yellow-800";case"evening":return"bg-orange-100 text-orange-800";case"night":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}},_=()=>{const t=S(D,g),c=r(D,g),j=[];for(let x=0;x<c;x++)j.push(e.jsx("div",{className:"p-2"},`empty-${x}`));for(let x=1;x<=t;x++){const U=b(x),K=new Date().getDate()===x&&new Date().getMonth()===g&&new Date().getFullYear()===D;j.push(e.jsxs("div",{className:`p-2 border rounded-lg min-h-[120px] ${K?"bg-primary/10 border-primary":"bg-card border-border"}`,children:[e.jsx("div",{className:"font-semibold mb-2",children:x}),e.jsx("div",{className:"space-y-1",children:U.map(($,W)=>e.jsxs("div",{className:`text-xs p-1 rounded ${y($.shift_type)}`,children:[e.jsx("div",{className:"font-medium",children:v($.shift_type)}),e.jsx("div",{className:"truncate",children:P($.doctor_id)})]},W))})]},x))}return j},H=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"],T=Array.from({length:10},(t,c)=>new Date().getFullYear()-2+c);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Nöbet Takvimi"}),e.jsx("p",{className:"text-muted-foreground",children:"Ay başından ay başına nöbet programını görüntüleyin ve yönetin"})]}),e.jsxs(B,{onClick:f,disabled:h,children:[e.jsx(q,{className:`mr-2 h-4 w-4 ${h?"animate-spin":""}`}),h?"Oluşturuluyor...":"Program Oluştur"]})]}),e.jsxs(M,{children:[e.jsx(Q,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(L,{value:g.toString(),onValueChange:t=>N(parseInt(t)),children:[e.jsx(z,{className:"w-32",children:e.jsx(F,{})}),e.jsx(Y,{children:H.map((t,c)=>e.jsx(V,{value:c.toString(),children:t},c))})]}),e.jsxs(L,{value:D.toString(),onValueChange:t=>A(parseInt(t)),children:[e.jsx(z,{className:"w-24",children:e.jsx(F,{})}),e.jsx(Y,{children:T.map(t=>e.jsx(V,{value:t.toString(),children:t},t))})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(R,{variant:"outline",children:[e.jsx(I,{className:"mr-1 h-3 w-3"}),i.length," Doktor"]}),e.jsxs(R,{variant:"outline",children:[e.jsx(O,{className:"mr-1 h-3 w-3"}),u.length," Nöbet"]})]})]})}),e.jsxs(k,{children:[e.jsx("div",{className:"grid grid-cols-7 gap-2 mb-4",children:["Pazar","Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi"].map(t=>e.jsx("div",{className:"p-2 text-center font-semibold text-muted-foreground",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 gap-2",children:_()})]})]}),u.length===0&&i.length>0&&e.jsx(M,{children:e.jsxs(k,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(O,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Nöbet programı oluşturulmamış"}),e.jsx("p",{className:"text-muted-foreground text-center mb-4",children:'Bu ay için nöbet programı oluşturmak için "Program Oluştur" butonuna tıklayın'}),e.jsxs(B,{onClick:f,disabled:h,children:[e.jsx(q,{className:`mr-2 h-4 w-4 ${h?"animate-spin":""}`}),"Program Oluştur"]})]})}),i.length===0&&e.jsx(M,{children:e.jsxs(k,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(I,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Doktor bilgisi bulunamadı"}),e.jsx("p",{className:"text-muted-foreground text-center mb-4",children:"Nöbet programı oluşturmak için önce doktor bilgilerini ekleyiniz"})]})})]})};export{le as default};
